---
name: Bronze CI - Fast checks

on:
  pull_request:
    types: [opened, reopened, synchronize]
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  bronze-checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install minimal tools
        run: |
          python -m pip install --upgrade pip
          pip install black ruff pytest pre-commit

      - name: Run Bronze checks (format, lint, smoke tests)
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}
        run: |
          set -euo pipefail
          echo "Detecting repo languages and running fast checks..."

          # Python checks (black + ruff + pytest smoke)
          if [ -f "pyproject.toml" ] || ls *.py >/dev/null 2>&1; then
            echo "> Python detected: running black/ruff checks"
            black --check .
            ruff .
            if [ -d "tests" ] || ls test_*.py >/dev/null 2>&1 || ls *_test.py >/dev/null 2>&1; then
              echo "> Running pytest smoke tests"
              pytest -q -m smoke || echo "pytest returned non-zero (if no smoke tests, this is fine)"
            fi
          fi

          # C/C++ checks (clang-format only check)
          if [ -f "CMakeLists.txt" ] || ls *.cpp *.c *.h >/dev/null 2>&1; then
            if command -v clang-format >/dev/null 2>&1; then
              echo "> clang-format available: running check"
              # Check if any files need formatting
              CLANG_OUTPUT=$(git ls-files -z | xargs -0 clang-format -output-replacements-xml)
              if echo "$CLANG_OUTPUT" | grep -q "<replacement "; then
                echo "clang-format check failed"
                exit 1
              else
                echo "clang-format check passed"
              fi
            else
              echo "> clang-format not available, skipping C/C++ format check"
            fi
          fi

          # Dart/Flutter checks (if present)
          if [ -f "pubspec.yaml" ]; then
            echo "> Flutter/Dart project detected"
            if command -v flutter >/dev/null 2>&1; then
              echo "> Running Flutter analyze"
              flutter analyze || echo "flutter analyze returned non-zero"
            else
              echo "> Flutter not available, skipping Dart checks"
            fi
          fi

          echo "Bronze checks complete!"
